<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Citizen Dashboard | Smart Waste Management</title>
  <link rel="stylesheet" href="assets/css/pages.css" />
  <style>
    .dash { max-width: 1200px; margin: 40px auto; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; padding: 0 20px; }
    .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
    .report-list img { width: 120px; height: auto; border-radius: 8px; }
    .report-item { display:flex; gap:15px; align-items:center; padding:15px 0; border-bottom:1px solid #eee;}
    .small { font-size:0.9rem; color:#555; }
    .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;}
    .points { font-weight:700; color:#004d40; }
    .badge { background:#ffca28; padding:5px 10px; border-radius:5px; font-size:0.8rem; }
    .quiz-section { margin-top:25px; }
    .quiz { display:none; }
    .quiz.active { display:block; }
    .question { margin-bottom:15px; }
    .question p { margin-bottom:8px; font-weight:500; }
    .question label { margin-right:10px; }
    hr { margin: 30px 0; border: none; border-top: 1px solid #eee; }
    .btn { margin-top: 10px; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
    .form-group input[type="file"] { margin-top: 5px; }
    .location-group { display: flex; align-items: center; gap: 10px; }
    .location-group .btn { margin: 0; }
    .location-group .small { margin: 0; }
    @media (max-width: 768px) { .dash { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header class="navbar">
    <div class="logo">
      <img src="assets/images/logo.png" alt="Logo" />
      <h1>Smart Waste Management</h1>
    </div>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="citizen.html" class="active">Citizen</a></li>
        <li><a href="chatbot.html">Chatbot</a></li>
        <li><a href="#" id="logout">Logout</a></li>
      </ul>
    </nav>
  </header>

  <main class="dash">
    <section class="card">
      <div class="top-bar">
        <div>
          <h2 id="userName">Welcome, Citizen</h2>
          <div class="small">Email: <span id="userEmail">not-set</span></div>
        </div>
        <div>
          <div class="points">Points: <span id="userPoints">0</span></div>
          <div class="badge" id="userBadge">None</div>
        </div>
      </div>
      <a href="edit-profile.html" class="btn">Edit Profile</a>

      <h3>Submit Waste Report</h3>
      <p class="small">Please provide details to report waste in your area. Attach a clear image and specify the location for accurate processing.</p>
      <form id="reportForm">
        <div class="form-group">
          <label for="image">Waste Image</label>
          <input type="file" id="image" name="image" accept="image/*" required />
          <div class="small">Upload a photo of the waste for verification.</div>
        </div>
        <div class="form-group">
          <label>Location</label>
          <div class="location-group">
            <button id="locBtn" type="button" class="btn">Get Current Location</button>
            <div class="small" id="locText">Location not set</div>
          </div>
          <div class="small">Click to automatically detect your location, or leave blank if not applicable.</div>
        </div>
        <input type="hidden" id="latitude" name="latitude" />
        <input type="hidden" id="longitude" name="longitude" />
        <div class="form-group">
          <button class="btn" type="submit">Submit Report</button>
        </div>
      </form>
      <div id="reportMsg" class="small" style="margin-top:15px;color:green"></div>
    </section>

    <section class="card">
      <h3>Your Reports</h3>
      <div id="reportsContainer" class="report-list">
        <p class="small">Loading your reports...</p>
      </div>

      <hr />
      <h3>Training Quizzes</h3>
      <button class="btn" onclick="startQuiz('quiz1')">Start Quiz 1</button>
      <button class="btn" onclick="startQuiz('quiz2')">Start Quiz 2</button>
      <div id="quizContainer" class="quiz-section">
        <div id="quiz1" class="quiz">
          <h4>Quiz 1</h4>
          <div id="questions1"></div>
          <button class="btn" onclick="submitQuiz('quiz1')">Submit Quiz 1</button>
        </div>
        <div id="quiz2" class="quiz">
          <h4>Quiz 2</h4>
          <div id="questions2"></div>
          <button class="btn" onclick="submitQuiz('quiz2')">Submit Quiz 2</button>
        </div>
      </div>
      <div id="quizMsg" class="small" style="margin-top:15px;"></div>

      <hr />
      <h3>Leaderboard</h3>
      <p class="small">See your rank among citizens.</p>
      <a href="leaderboard.html" class="btn" style="margin-top:10px;">Go to Leaderboard</a>
    </section>
  </main>

<script>
  const backend = "http://localhost:5000";
  const token = localStorage.getItem("token");
  if (!token) { alert("Login first"); window.location.href = "login.html"; }

  let userEmail = localStorage.getItem("userEmail");
  if (!userEmail) {
    userEmail = prompt("Enter your registered email:");
    if (userEmail) localStorage.setItem("userEmail", userEmail);
  }

  const userEmailSpan = document.getElementById("userEmail");
  const userName = document.getElementById("userName");
  const userPointsSpan = document.getElementById("userPoints");
  const userBadgeSpan = document.getElementById("userBadge");

  if (userEmail) {
    userEmailSpan.textContent = userEmail;
    userName.textContent = "Welcome, " + userEmail.split("@")[0];
  }

  document.getElementById("logout").addEventListener("click", () => {
    localStorage.clear();
    window.location.href = "login.html";
  });

  const locBtn = document.getElementById("locBtn");
  const locText = document.getElementById("locText");
  const latInput = document.getElementById("latitude");
  const lngInput = document.getElementById("longitude");

  locBtn.addEventListener("click", () => {
    if (!navigator.geolocation) {
      locText.textContent = "Geolocation not supported.";
      return;
    }
    locText.textContent = "Getting location...";
    navigator.geolocation.getCurrentPosition((pos) => {
      const lat = pos.coords.latitude.toFixed(6);
      const lon = pos.coords.longitude.toFixed(6);
      latInput.value = lat;
      lngInput.value = lon;
      locText.textContent = `Location set: ${lat}, ${lon}`;
    }, (err) => {
      console.error(err);
      locText.textContent = "Unable to get location: " + err.message;
    }, { enableHighAccuracy: true, timeout: 10000 });
  });

  const reportForm = document.getElementById("reportForm");
  const reportMsg = document.getElementById("reportMsg");

  reportForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!userEmail) {
      alert("Email not set.");
      return;
    }
    const fileInp = document.getElementById("image");
    if (!fileInp.files || fileInp.files.length === 0) {
      alert("Please attach an image.");
      return;
    }

    const fd = new FormData();
    fd.append("image", fileInp.files[0]);
    fd.append("email", userEmail);
    fd.append("latitude", latInput.value || "");
    fd.append("longitude", lngInput.value || "");

    reportMsg.textContent = "Uploading...";
    reportMsg.style.color = "blue";
    try {
      const res = await fetch(`${backend}/api/citizen/submit-report`, {
        method: "POST",
        headers: { Authorization: `Bearer ${token}` },
        body: fd
      });
      const json = await res.json();
      if (json.success) {
        reportMsg.style.color = "green";
        reportMsg.textContent = "Report submitted successfully!";
        loadReports();
        loadProfile(); // Refresh points/badge
      } else {
        reportMsg.style.color = "red";
        reportMsg.textContent = json.message || "Upload failed";
      }
    } catch (err) {
      console.error(err);
      reportMsg.style.color = "red";
      reportMsg.textContent = "Upload error";
    }
  });

  async function loadReports() {
    const container = document.getElementById("reportsContainer");
    if (!userEmail) {
      container.innerHTML = "<p class='small'>Email not set.</p>";
      return;
    }
    container.innerHTML = "<p class='small'>Loading...</p>";
    try {
      const res = await fetch(`${backend}/api/citizen/my-reports?email=${encodeURIComponent(userEmail)}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const json = await res.json();
      if (!json.success) {
        container.innerHTML = `<p class="small">${json.message || "Failed to load"}</p>`;
        return;
      }
      const reports = json.reports;
      if (!reports || reports.length === 0) {
        container.innerHTML = "<p class='small'>No reports yet.</p>";
        return;
      }
      container.innerHTML = "";
      reports.forEach(r => {
        const div = document.createElement("div");
        div.className = "report-item";
        const img = document.createElement("img");
        img.src = r.image_url || "";
        const meta = document.createElement("div");
        meta.innerHTML = `<div><strong>Status:</strong> ${r.status}</div>
                          <div class="small">Uploaded: ${new Date(r.created_at).toLocaleString()}</div>
                          <div class="small">Location: ${r.latitude || '-'}, ${r.longitude || '-'}</div>`;
        div.appendChild(img);
        div.appendChild(meta);
        container.appendChild(div);
      });
    } catch (err) {
      console.error(err);
      container.innerHTML = "<p class='small'>Error loading reports.</p>";
    }
  }

  async function loadProfile() {
    try {
      const res = await fetch(`${backend}/api/user/profile`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const json = await res.json();
      if (json.success) {
        const user = json.user;
        userPointsSpan.textContent = user.points;
        userBadgeSpan.textContent = user.badge;
      }
    } catch (err) {
      console.error("Error loading profile:", err);
    }
  }

  function startQuiz(quizId) {
    document.querySelectorAll('.quiz').forEach(q => q.classList.remove('active'));
    document.getElementById(quizId).classList.add('active');
    fetch(`${backend}/api/quiz/${quizId}`, {
      headers: { Authorization: `Bearer ${token}` }
    }).then(res => res.json()).then(json => {
      if (json.success) {
        const questionsDiv = document.getElementById(`questions${quizId.slice(-1)}`);
        questionsDiv.innerHTML = json.quiz.map((q, i) => `
          <div class="question">
            <p>${i+1}. ${q.question}</p>
            ${q.options.map((opt, j) => `<label><input type="radio" name="q${i}" value="${j}"> ${opt}</label><br>`).join('')}
          </div>
        `).join('');
      }
    });
  }

  function submitQuiz(quizId) {
    const answers = [];
    const questions = document.querySelectorAll(`#questions${quizId.slice(-1)} .question`);
    questions.forEach((q, i) => {
      const selected = q.querySelector(`input[name="q${i}"]:checked`);
      answers.push(selected ? selected.value : null);
    });
    fetch(`${backend}/api/quiz/${quizId}/submit`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ quizId, answers })
    }).then(res => res.json()).then(json => {
      const msg = document.getElementById("quizMsg");
      if (json.success) {
        msg.style.color = "green";
        msg.textContent = `Quiz submitted! Score: ${json.score}/${answers.length}. Points added: ${json.pointsAdded}`;
        loadProfile();
      } else {
        msg.style.color = "red";
        msg.textContent = json.message;
      }
    });
  }

  loadReports();
  loadProfile();
</script>
</body>
</html>